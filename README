# Module to aid in the creation of a shared CA Puppet Infrastructure

## Goal: Have a single CA/Console host on your network that any number of masters can submit inventory to (over REST) and can particpate in an ActiveMQ mesh.

This module aids in some of the tasks (mostly file copies & deletions) that you'll need to do to pull this off.

## Pre-Requisites

* Install PE 2.5 onto a host with the master, agent & console roles selected (you'll get CA for free). Referred to as the Console host.

* Install PE 2.5 on any number of hosts with just the master & agent roles (no console). Referred to as Master hosts.

* Copy the following data into this modules files directory --from the Console host--:
  /etc/puppetlabs/puppet/ssl/ca
  /etc/puppetlabs/mcollective/credentials

You'll also need to copy in the pe_mcollective module we provided you until a compatible version makes it way into a PE 2.5.x release.
  pe_mcollective -> thismodule/files/pe_mcollective


## Workflow

### Run Puppet Apply on this Module
Once those prerequisites are met, you should run puppet apply against this module on each of your systems to prepare the hosts. For example, if you place the module into /root/ temporarily, puppet apply --modulepath=/root/ --execute 'include shared_ca'

On a Console host, this declared class will:
  * Stop services: pe-puppet, pe-httpd, pe-mcollective & pe-activemq
  * Copy the pe_mcollective module to /etc/puppetlabs/puppet/modules
  * Purge MCollective Certificates
  * Purge an old create_resources function that shipped with PE 2.5 by accident.

On a Master host, this declared class will:
  * Do the same as on a Console host, plus:
  * Purge the hosts entire $cadir & replace it with your Console hosts $cadir
  * Replace /etc/puppetlabs/mcollective/credentials with one from your Console host
  * Purge the Master host certificate/key pair that were created during install.

### Restart Services
Once the module has done it's business, you have two paths to continue.

On a Console Host:
  * Start the pe-httpd service.
  * Run 'puppet agent -t' which should now regenerate MCollective certificates and restart pe-mcollective and pe-activemq.
  * Depending on whether you're autosigning certificates, you may need to sign the MCollective certificate. puppet cert --list & puppet cert --sign as appropriate.
  * Optionally turn back on the pe-puppet service.

On a Master Host:
  * Start a Puppet Master manually, as it needs to get new certs from your shared CA.
  * * puppet master --no-daemonize --debug
  * * Once that's done (you should see it startup successfully), you can control+C the process.
  * Start the pe-httpd service.
  * Run 'puppet agent -t' which should now regenerate MCollective certificates and restar
t pe-mcollective and pe-activemq.
  * Depending on whether you're autosigning certificates, you may need to sign the MColle
ctive certificate. puppet cert --list & puppet cert --sign as appropriate.
  * Optionally turn back on the pe-puppet service.
